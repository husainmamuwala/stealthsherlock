# Import dependencies
import hashlib
import os
import requests
from flask import Blueprint, jsonify, request


# Root directory path
ROOT_DIR = os.getcwd()

# Malware Analysis Blueprint
ma = Blueprint('malware', __name__, url_prefix='/malware')

@ma.route('/file', methods=["POST"])
def check_file():
    """Check if file hash exists in the database"""
    if 'file' not in request.files:
        return 'No file part', 400
    file = request.files['file']
    file_content = file.read()
    print(file)
    

    # Set the file pointer back to the beginning of the file
    file.seek(0)    

    print("received file content length:", len(file_content))  # Debugging statement

    resp = requests.post("https://www.virustotal.com/api/v3/files", headers={"x-apikey": "a37ccd6ae8bd52daabcd8554e7d6d65862831b98d7a691d0c0e7205140045fe5"}, files={"file": file_content})
    if not resp.ok:
        print("VirusTotal API request failed with status code:", resp.status_code)  # Debugging statement
        return jsonify({
            'status': 400,
            'message': 'Something went wrong'
        })

    print("VirusTotal API response:", resp.text)  # Debugging statement

    return jsonify({
        'status': 200,
        'data': resp.json().get('data').get('id')
    })


@ma.route('/file/<file_id>', methods=["GET"])
def get_file_analysis(file_id):
    """Get file analysis"""
    resp = requests.get(f"https://www.virustotal.com/api/v3/analyses/{file_id}", headers={"x-apikey": "a37ccd6ae8bd52daabcd8554e7d6d65862831b98d7a691d0c0e7205140045fe5"})
    if not resp.ok:
        return jsonify({
            'status': 400,
            'message': 'Something went wrong'
        })

    return jsonify({
        'status': 200,
        'data': resp.json().get('data')
    })


@ma.route('/hash', methods=["POST"])
def check_hash():
    """Check if file hash exists in the database"""
    file = request.files.get("file")
    file_content = file.read() 
    file_hash = hashlib.sha256(file_content).hexdigest()

    resp = requests.get(f"https://www.virustotal.com/api/v3/files/{file_hash}", headers={"x-apikey": "a37ccd6ae8bd52daabcd8554e7d6d65862831b98d7a691d0c0e7205140045fe5"})
    if not resp.ok:
        return jsonify({
            'status': 400,
            'message': 'File hash not found in database'
        })

    return jsonify({
        'status': 200,
        'data': resp.json().get('data')
    })